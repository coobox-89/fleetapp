<%- include('partials/header', { title: "Dettaglio Auto", user: user }) %>

<div class="max-w-4xl mx-auto p-4">
  <!-- Header row: Titolo e bottoni funzione allineati -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold"><%= car.brand %> <%= car.model %></h1>
    <div class="flex space-x-2">
      <!-- I bottoni usano la classe "btn" con dimensioni ridotte (px-2 py-1 text-sm) per avere lo stesso stile del tasto "Modifica" -->
      <button id="printBtn" class="btn px-2 py-1 text-sm" title="Stampa"><i class="fa-solid fa-print fa-lg mr-2"></i>Stampa</button>
      <button id="pdfBtn" class="btn px-2 py-1 text-sm" title="Genera PDF"><i class="fa-solid fa-file-pdf mr-2"></i>PDF</button>
      <button id="mailBtn" class="btn px-2 py-1 text-sm" title="Invia via Mail"><i class="fa-solid fa-envelope mr-2"></i>Mail</button>
    </div>
  </div>

  <div class="flex flex-col md:flex-row">
    <!-- Colonna sinistra: Immagine principale, Pulsanti Modifica ed Elimina e Scheda Danni -->
    <div class="md:w-1/3 mb-4 md:mb-0">
      <% 
        let imagesArray;
        try {
          imagesArray = JSON.parse(car.image_url);
          if (!Array.isArray(imagesArray)) { imagesArray = [imagesArray]; }
        } catch(e) {
          imagesArray = [car.image_url || '/uploads/default_car.png'];
        }
      %>
      <div class="mb-4">
        <!-- Immagine principale con max-height ridotto a 250px -->
        <img src="<%= imagesArray[0] %>" alt="<%= car.brand %> <%= car.model %>" class="w-full object-contain rounded mb-4" style="max-height:250px;">
      </div>
      <div class="mb-4 flex space-x-2">
      <div class="italian-plate">
        <!-- Sezione sinistra (EU + I) -->
        <div class="plate-left">
          <!-- Logo UE: sostituisci con un’immagine reale delle stelle UE, 
               o un’icona/sprite a tua scelta -->
          <div class="eu-logo"></div>
          <span class="country-code">I</span>
        </div>
      
        <!-- Sezione centrale con il numero di targa -->
        <div class="plate-center">
          <span class="plate-number"><%= car.license_plate %></span>
        </div>
      
        <!-- Sezione destra (blu con cerchio) -->
        <div class="plate-right">
          <!-- Cerchio dorato o placeholders per province, adesivi, etc. -->
          <div class="right-circle"></div>
        </div>
      </div>
      </div>

      <!-- Pulsanti: Modifica ed Elimina -->
      <div class="mb-4 flex space-x-2">
        <a href="/cars/edit/<%= car.id %>" class="btn px-4 py-2">
          <i class="fas fa-pencil-alt mr-2"></i> Modifica
        </a>
        <button type="button" class="btn px-4 py-2 bg-red-600" onclick="openDeleteModal()">
          <i class="fas fa-trash mr-2"></i> Elimina
        </button>
      </div>
      <!-- Scheda Danni Interattiva -->
      <section class="mb-4">
        <h2 class="text-xl font-bold mb-2">Segnala Danno</h2>
        <!-- Il container usa l'immagine fissa che comprende già tutte le viste -->
        <div id="damageSchematicContainer" class="relative mx-auto" style="width:300px; height:180px; border:2px solid #66cc66;">
          <svg id="damageSchematic" width="300" height="180" viewBox="0 0 300 180">
            <image href="/assets/scheda-danni.png" x="0" y="0" width="300" height="180" preserveAspectRatio="xMidYMid meet" />
          </svg>
        </div>
        <p class="mt-2 text-xs">Clicca sullo schema per segnalare o rimuovere punti di danno. Se clicchi nuovamente su un marker (entro 10px) verrà rimosso.</p>
      </section>
    </div>

    <!-- Colonna destra: Dati dell'auto -->
    <div class="md:w-2/3 md:ml-6">
      <!-- Informazioni Base -->
      <section class="mb-6">
        <h2 class="text-2xl font-bold border-b border-gray-600 pb-2 mb-4">Informazioni Base</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div class="whitespace-nowrap"><span class="font-bold">Marca:</span> <span class="break-words"><%= car.brand %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Modello:</span> <span class="break-words"><%= car.model %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Targa:</span> <span class="break-words"><%= car.license_plate %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Driver:</span> <span class="break-words"><%= car.assigned_driver %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Colore:</span> <span class="break-words"><%= car.color %></span></div>
        </div>
      </section>

      <!-- Dettagli Tecnici -->
      <section class="mb-6">
        <h2 class="text-2xl font-bold border-b border-gray-600 pb-2 mb-4">Dettagli Tecnici</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div class="whitespace-nowrap"><span class="font-bold">Anno:</span> <span class="break-words"><%= car.year %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Tipo carburante:</span> <span class="break-words"><%= car.fuel_type %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Cilindrata:</span> <span class="break-words"><%= car.engine_capacity %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Potenza:</span> <span class="break-words"><%= car.horsepower %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Trasmissione:</span> <span class="break-words"><%= car.transmission %></span></div>
        </div>
      </section>

      <!-- Contratto e Utilizzo -->
      <section class="mb-6">
        <h2 class="text-2xl font-bold border-b border-gray-600 pb-2 mb-4">Contratto e Utilizzo</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div class="whitespace-nowrap"><span class="font-bold">Ultima manutenzione:</span> <span class="break-words"><%= car.last_maintenance_date %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Chilometraggio:</span> <span class="break-words"><%= car.mileage %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Inizio contratto:</span> <span class="break-words"><%= car.contract_start_date %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Scadenza contratto:</span> <span class="break-words"><%= car.contract_end_date %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Costo mensile:</span> <span class="break-words"><%= car.monthly_cost %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Costo annuo:</span> <span class="break-words"><%= car.annual_cost %></span></div>
        </div>
      </section>

      <!-- Assicurazione e Documentazione -->
      <section class="mb-6">
        <h2 class="text-2xl font-bold border-b border-gray-600 pb-2 mb-4">Assicurazione e Documentazione</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div class="whitespace-nowrap"><span class="font-bold">Scadenza assicurazione:</span> <span class="break-words"><%= car.insurance_expiry_date %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Polizza:</span> <span class="break-words"><%= car.insurance_policy_number %></span></div>
          <div class="whitespace-nowrap"><span class="font-bold">Revisione:</span> <span class="break-words"><%= car.inspection_date %></span></div>
        </div>
      </section>

      <!-- Informazioni Aggiuntive -->
      <section class="mb-6">
        <h2 class="text-2xl font-bold border-b border-gray-600 pb-2 mb-4">Informazioni Aggiuntive</h2>
        <div class="text-sm">
          <p><span class="font-bold">Note:</span></p>
          <p class="break-words"><%= car.additional_notes %></p>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Modal di Conferma Eliminazione -->
<div id="deleteModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-gray-900 p-6 rounded shadow-lg">
    <h3 class="text-xl font-bold mb-4">Conferma Eliminazione</h3>
    <p class="mb-6">Sei sicuro di voler eliminare questa auto? Questa azione è irreversibile.</p>
    <div class="flex justify-end">
      <button type="button" class="btn px-4 py-2 mr-2" onclick="closeDeleteModal()">Annulla</button>
      <form action="/cars/delete/<%= car.id %>" method="POST">
        <button type="submit" class="btn px-4 py-2 bg-red-600">Elimina</button>
      </form>
    </div>
  </div>
</div>

<!-- Script per i bottoni esistenti -->
<script>
  // Funzione per stampare la pagina
  document.getElementById('printBtn').addEventListener('click', function() {
    window.print();
  });

  // Funzione per generare PDF (richiede jsPDF)
  document.getElementById('pdfBtn').addEventListener('click', function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.html(document.querySelector('body'), {
      callback: function(doc) {
        doc.save('scheda_auto.pdf');
      },
      x: 10,
      y: 10
    });
  });

  // Funzione per inviare via mail
  document.getElementById('mailBtn').addEventListener('click', function() {
    const subject = encodeURIComponent("Scheda Auto - <%= car.brand %> <%= car.model %>");
    const body = encodeURIComponent("Ecco la scheda auto:\n\n" + document.body.innerText);
    window.location.href = "mailto:?subject=" + subject + "&body=" + body;
  });

  // Funzioni per il Modal di Eliminazione
  function openDeleteModal() {
    document.getElementById('deleteModal').classList.remove('hidden');
  }
  function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
  }
</script>

<!-- Script per la Scheda Danni Interattiva con persistenza -->
<script>
  const markersStorageKey = "damageMarkers_<%= car.id %>";
  let damageMarkers = [];

  function loadDamageMarkers() {
    const stored = localStorage.getItem(markersStorageKey);
    if (stored) {
      try {
        return JSON.parse(stored);
      } catch(e) {
        return [];
      }
    }
    return [];
  }

  function saveDamageMarkers(markers) {
    localStorage.setItem(markersStorageKey, JSON.stringify(markers));
  }

  function updateLocalStorageMarkers() {
    const markersData = damageMarkers.map(marker => ({
      cx: marker.getAttribute("cx"),
      cy: marker.getAttribute("cy")
    }));
    saveDamageMarkers(markersData);
  }

  function renderDamageMarkers() {
    const markersData = loadDamageMarkers();
    markersData.forEach(data => {
      const marker = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      marker.setAttribute("cx", data.cx);
      marker.setAttribute("cy", data.cy);
      marker.setAttribute("r", 8);
      marker.setAttribute("fill", "red");
      marker.setAttribute("class", "damage-marker");
      document.getElementById('damageSchematic').appendChild(marker);
      damageMarkers.push(marker);
    });
  }
  renderDamageMarkers();

  function findNearbyMarker(x, y, threshold = 10) {
    for (let marker of damageMarkers) {
      const cx = parseFloat(marker.getAttribute('cx'));
      const cy = parseFloat(marker.getAttribute('cy'));
      const dx = x - cx;
      const dy = y - cy;
      if (Math.sqrt(dx * dx + dy * dy) < threshold) {
        return marker;
      }
    }
    return null;
  }

  const schematic = document.getElementById('damageSchematic');
  schematic.addEventListener('click', function(event) {
    const pt = schematic.createSVGPoint();
    pt.x = event.clientX;
    pt.y = event.clientY;
    const svgP = pt.matrixTransform(schematic.getScreenCTM().inverse());

    const existingMarker = findNearbyMarker(svgP.x, svgP.y);
    if (existingMarker) {
      schematic.removeChild(existingMarker);
      damageMarkers = damageMarkers.filter(m => m !== existingMarker);
    } else {
      const newMarker = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      newMarker.setAttribute("cx", svgP.x);
      newMarker.setAttribute("cy", svgP.y);
      newMarker.setAttribute("r", 8);
      newMarker.setAttribute("fill", "red");
      newMarker.setAttribute("class", "damage-marker");
      schematic.appendChild(newMarker);
      damageMarkers.push(newMarker);
    }
    updateLocalStorageMarkers();
  });
</script>

<%- include('partials/footer') %>
